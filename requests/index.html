<!-- song-request-form.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Song Request</title>
    <link rel="stylesheet" href="song-request-form.css" />
  </head>
  <body>
    <main class="wrapper">
      <h1 class="title">🎵 Request a Song</h1>
      <form
        id="requestForm"
        class="form"
        aria-describedby="confirmation"
        novalidate
      >
        <label for="searchInput" class="visually-hidden">🔍 Search song</label>
        <input
          type="search"
          id="searchInput"
          class="input"
          placeholder="Start typing a song…"
          autocomplete="off"
          required
          aria-autocomplete="list"
          aria-controls="suggestions"
          aria-live="polite"
        />

        <ul
          id="suggestions"
          class="suggestions"
          role="listbox"
          aria-label="Song suggestions"
        ></ul>

        <!-- Hidden fields populated on select -->
        <input type="hidden" id="artist" name="artist" />
        <input type="hidden" id="title" name="title" />
        <input type="hidden" id="appleMusicUrl" name="appleMusicUrl" />
        <input type="hidden" id="artworkUrl" name="artworkUrl" />
        <input type="hidden" id="genre" name="genre" />
        <input type="hidden" id="releaseYear" name="releaseYear" />
        <input type="hidden" id="bpm" name="bpm" />

        <div
          id="selectedSongCard"
          class="card hidden"
          role="region"
          aria-live="polite"
        >
          <h2 class="card-heading">Your request</h2>
          <div class="card-body">
            <img
              id="cardArtwork"
              src=""
              alt="Song artwork"
              class="card-thumb"
            />
            <div>
              <div id="cardTitle" class="card-title"></div>
              <div id="cardArtist" class="card-artist"></div>
            </div>
          </div>
        </div>

        <button type="submit" id="submitButton" class="button" disabled>
          Submit
        </button>
      </form>

      <div id="confirmation" class="confirmation hidden" role="status">
        ✅ Song request sent!
      </div>
      <div id="warning" class="warning-message hidden" role="alert"></div>

      <hr class="divider" />
      <section class="tip-footer">
        <h2>🎧 Follow the DJ</h2>
        <a
          href="https://www.instagram.com/lewiswakedj"
          class="button"
          target="_blank"
          rel="noopener noreferrer"
        >
          📸 Instagram
        </a>
        <a
          href="https://www.tiktok.com/@lewiswakedj"
          class="button"
          target="_blank"
          rel="noopener noreferrer"
        >
          🎶 TikTok
        </a>
      </section>

      <hr class="divider" />
      <section class="tip-footer">
        <h2>🍻 Buy the DJ a drink</h2>
        <a
          href="https://www.paypal.me/lewiswake"
          class="button"
          target="_blank"
          rel="noopener noreferrer"
        >
          💳 PayPal
        </a>
      </section>
    </main>

    <!-- Blocked Artist Modal -->
    <div id="blockedArtistModal" class="modal-overlay">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <!-- X close button -->
        <button type="button" class="modal-close-btn" onclick="closeBlockedArtistModal()" aria-label="Close">
          &times;
        </button>

        <h3 id="modalTitle" class="modal-title">
          <span id="blockedArtistNameTitle">Artist</span> requests blocked
        </h3>
        <p class="modal-message">
          Whoops! This artist is blocked due to serious controversy. We don't want their music killing the vibe tonight! Read the BBC article below for details.
        </p>
        
        <!-- Link is centered -->
        <div class="modal-link-container">
          <a
            id="blockedArtistLink"
            href=""
            target="_blank"
            rel="noopener noreferrer"
            class="modal-link"
          >
            Read article
          </a>
        </div>
      </div>
    </div>
    <!-- End Blocked Artist Modal -->

    <!-- Social Media Modal (Restored with updated CSS provided) -->
    <div id="socialModal" class="modal hidden">
      <div class="modal-content">
        <span class="close-button" onclick="closeSocialModal()">×</span>
        <h2>Thanks for requesting!</h2>
        <p>Enjoying the music? Follow me on social media to stay up to date!</p>
        <div class="modal-links">
          <a
            href="https://www.instagram.com/lewiswakedj"
            class="button"
            target="_blank"
            rel="noopener noreferrer"
          >
            📸 Instagram
          </a>
          <a
            href="https://www.tiktok.com/@lewiswakedj"
            class="button"
            target="_blank"
            rel="noopener noreferrer"
          >
            🎶 TikTok
          </a>
        </div>
      </div>
    </div>
    <!-- End Social Media Modal -->
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      (function () {
        // ——— Firebase Configuration ———
        const firebaseConfig = {
          apiKey: "AIzaSyBLZp3f5WAWkAJDpBidh-C2mib2nhnLys4",
          authDomain: "song-request-a8a68.firebaseapp.com",
          projectId: "song-request-a8a68",
          storageBucket: "song-request-a8a68.appspot.com",
          messagingSenderId: "522633732679",
          appId: "1:522633732679:web:564894980a2e0484828762",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ——— Spotify Credentials ———
        const SPOTIFY_ID = "87b9b15a818244ef8604136016427eb8";
        const SPOTIFY_SECRET = "6787632ded984a939f3fbef54921a3b1";

        // ——— DOM Elements ———
        const searchInput = document.getElementById("searchInput");
        const suggestions = document.getElementById("suggestions");
        const form = document.getElementById("requestForm");
        const submitBtn = document.getElementById("submitButton");
        const confirmation = document.getElementById("confirmation");
        const warning = document.getElementById("warning");
        const card = document.getElementById("selectedSongCard");
        const cardArtwork = document.getElementById("cardArtwork");
        const cardTitle = document.getElementById("cardTitle");
        const cardArtist = document.getElementById("cardArtist");
        
        // Modal DOM Elements
        const blockedArtistModal = document.getElementById("blockedArtistModal");
        const blockedArtistNameTitle = document.getElementById("blockedArtistNameTitle");
        const blockedArtistLinkAnchor = document.getElementById("blockedArtistLink");
        const socialModal = document.getElementById("socialModal");

        let debounceTimer;

        // ——— Modal Functions ———
        window.closeBlockedArtistModal = function() {
          blockedArtistModal.classList.remove("open");
          blockedArtistModal.setAttribute("aria-hidden", "true");
          searchInput.disabled = false;
          searchInput.value = ''; 
          clearSuggestions();
        }
        
        window.closeSocialModal = function() {
          socialModal.classList.add("hidden");
        }

        function showBlockedArtistModal(artist, link) {
          blockedArtistNameTitle.textContent = artist; 
          blockedArtistLinkAnchor.href = link;
          blockedArtistModal.classList.add("open");
          blockedArtistModal.setAttribute("aria-hidden", "false");
          searchInput.disabled = true;
        }

        // --- New: Backdrop close logic ---
        blockedArtistModal.addEventListener('click', (e) => {
            // Check if the click occurred directly on the modal overlay, not its content
            if (e.target === blockedArtistModal) {
                closeBlockedArtistModal();
            }
        });


        // ——— Utility Functions ———
        function getDeviceId() {
          let deviceId = localStorage.getItem("deviceId");
          if (!deviceId) {
            deviceId =
              "device-" +
              Date.now() +
              "-" +
              Math.random().toString(36).substr(2, 9);
            localStorage.setItem("deviceId", deviceId);
          }
          return deviceId;
        }

        function getRequestData() {
          const deviceId = getDeviceId();
          try {
            return (
              JSON.parse(localStorage.getItem(`requests_data_${deviceId}`)) || {
                timestamps: [],
                songKeys: [],
              }
            );
          } catch (e) {
            console.error("Failed to parse request data from localStorage:", e);
            return { timestamps: [], songKeys: [] };
          }
        }

        function saveRequestData(timestamp, songKey) {
          const deviceId = getDeviceId();
          let data = getRequestData();
          data.timestamps.push(timestamp);
          data.songKeys.push(songKey);
          localStorage.setItem(
            `requests_data_${deviceId}`,
            JSON.stringify(data)
          );
        }

        function isRateLimited() {
          const data = getRequestData();
          const fifteenMinutesAgo = Date.now() - 900000;
          const recentRequests = data.timestamps.filter(
            (ts) => ts > fifteenMinutesAgo
          );

          // Update local storage with filtered list to prevent it from growing indefinitely
          data.timestamps = recentRequests;
          localStorage.setItem(
            `requests_data_${getDeviceId()}`,
            JSON.stringify(data)
          );

          const limit = 3;
          return recentRequests.length >= limit;
        }

        function isDuplicateRequest(songKey) {
          const data = getRequestData();
          return data.songKeys.includes(songKey);
        }

        function debounce(fn, delay = 300) {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(fn, delay);
        }

        function clearSuggestions() {
          suggestions.innerHTML = "";
          suggestions.setAttribute("aria-expanded", "false");
        }
        function showCard() {
          card.classList.remove("hidden");
          submitBtn.disabled = false;
        }

        searchInput.addEventListener("input", () => {
          debounce(async () => {
            const q = searchInput.value.trim();
            if (q.length < 2) return clearSuggestions();
            searchInput.disabled = false;
            
            try {
              const res = await fetch(
                `https://itunes.apple.com/search?term=${encodeURIComponent(
                  q
                )}&entity=song&limit=5`
              );
              const { results } = await res.json();
              suggestions.innerHTML = "";
              suggestions.setAttribute("aria-expanded", "true");
              results.forEach((t) => {
                const li = document.createElement("li");
                li.className = "suggestion-item";
                li.setAttribute("role", "option");
                li.innerHTML = `
                  <img src="${t.artworkUrl60}" class="suggestion-thumb" />
                  <div class="suggestion-text">
                    <div class="track-title">${t.trackName}</div>
                    <div class="track-artist">${t.artistName}</div>
                  </div>
                `;
                li.addEventListener("click", () => selectTrack(t));
                suggestions.appendChild(li);
              });
            } catch (err) {
              console.error("Search failed:", err);
              clearSuggestions();
            }
          });
        });

        function selectTrack(track) {
          const artistName = track.artistName.toLowerCase();
          
          let blockedLink = null;
          let blockedArtistDisplayName = null;

          // --- Blocked Artist Logic ---

          // Dizzee Rascal
          if (artistName.includes("dizzee rascal")) {
            blockedArtistDisplayName = "Dizzee Rascal";
            blockedLink = "https://www.bbc.co.uk/news/uk-england-london-61037308";
          }
          
          // Kanye West (Ye)
          if (artistName.includes("kanye west") || artistName.includes("ye")) {
            blockedArtistDisplayName = "Kanye West (Ye)";
            blockedLink = "https://www.bbc.co.uk/news/articles/cvge48j5lplo";
          }
          
          // P. Diddy (Sean Combs, Puff Daddy, Diddy)
          if (artistName.includes("p. diddy") || artistName.includes("diddy") || artistName.includes("puff daddy") || artistName.includes("sean combs")) {
            blockedArtistDisplayName = "P. Diddy / Sean Combs";
            blockedLink = "https://www.bbc.co.uk/news/articles/c0qz32wzeego";
          }
          
          // R. Kelly
          if (artistName.includes("r. kelly") || artistName.includes("robert kelly")) {
            blockedArtistDisplayName = "R. Kelly";
            blockedLink = "https://www.bbc.co.uk/news/world-us-canada-61989606";
          }

          // Chris Brown
          if (artistName.includes("chris brown")) {
            blockedArtistDisplayName = "Chris Brown";
            blockedLink = "https://www.bbc.co.uk/news/topics/c5m8r32ll7rt";
          }

          // Marilyn Manson
          if (artistName.includes("marilyn manson") || artistName.includes("brian warner")) {
            blockedArtistDisplayName = "Marilyn Manson";
            blockedLink = "https://www.bbc.co.uk/news/entertainment-arts-57685153";
          }
          
          // Lostprophets
          if (artistName.includes("lostprophets") || artistName.includes("lost prophets") || artistName.includes("lost prophet")) {
            blockedArtistDisplayName = "Lostprophets";
            blockedLink = "https://www.bbc.co.uk/news/uk-wales-25412675";
          }


          // If a blocked artist is found, show the modal and stop
          if (blockedLink) {
            clearSuggestions();
            card.classList.add("hidden");
            submitBtn.disabled = true;
            showBlockedArtistModal(blockedArtistDisplayName, blockedLink);
            return;
          }

          // --- Normal Selection Logic ---
          form.artist.value = track.artistName;
          form.title.value = track.trackName;
          form.appleMusicUrl.value = track.trackViewUrl;
          form.artworkUrl.value = track.artworkUrl100;

          cardArtwork.src = track.artworkUrl100;
          cardArtwork.alt = `${track.trackName} artwork`;
          cardTitle.textContent = track.trackName;
          cardArtist.textContent = track.artistName;
          clearSuggestions();

          // Genre & Year
          const genreVal = track.primaryGenreName;
          const yearVal = new Date(track.releaseDate).getFullYear();
          form.genre.value = genreVal;
          form.releaseYear.value = yearVal;

          // Fetch BPM directly
          fetchSpotifyBPM(track.trackName, track.artistName)
            .then((tempo) => {
              form.bpm.value = Math.round(tempo);
              showCard();
            })
            .catch((err) => {
              console.warn("BPM fetch failed:", err);
              form.bpm.value = 0;
              showCard();
            });
        }

        async function fetchSpotifyBPM(title, artist) {
          const creds = btoa(`${SPOTIFY_ID}:${SPOTIFY_SECRET}`);
          const tokenRes = await fetch(
            "https://accounts.spotify.com/api/token",
            {
              method: "POST",
              headers: {
                Authorization: `Basic ${creds}`,
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: "grant_type=client_credentials",
            }
          );
          if (!tokenRes.ok) throw new Error("Failed to fetch token");
          const { access_token } = await tokenRes.json();

          const q = encodeURIComponent(`track:${title} artist:${artist}`);
          const searchRes = await fetch(
            `https://api.spotify.com/v1/search?q=$${q}&type=track&limit=1`,
            { headers: { Authorization: `Bearer ${access_token}` } }
          );
          const items = (await searchRes.json()).tracks.items;
          if (!items.length) throw new Error("No track match");

          const featRes = await fetch(
            `https://api.spotify.com/v1/audio-features/$${items[0].id}`,
            { headers: { Authorization: `Bearer ${access_token}` } }
          );
          const { tempo } = await featRes.json();
          return tempo;
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (isRateLimited()) {
            warning.textContent =
              "You've reached the request limit. Please try again in 15 minutes.";
            warning.classList.remove("hidden");
            submitBtn.disabled = true;
            return;
          }

          const artistVal = form.artist.value;
          const titleVal = form.title.value;
          const key = `${artistVal.toLowerCase()}||${titleVal.toLowerCase()}`;

          if (isDuplicateRequest(key)) {
            warning.textContent =
              "You've already requested this song! Anything else?";
            warning.classList.remove("hidden");
            submitBtn.disabled = false;
            return;
          }

          submitBtn.disabled = true;

          const appleMusicUrlVal = form.appleMusicUrl.value;
          const artworkUrlVal = form.artworkUrl.value;
          const genreVal = form.genre.value;
          const releaseYearVal = parseInt(form.releaseYear.value, 10);
          const bpmVal = parseInt(form.bpm.value, 10);

          const now = Date.now();
          const docRef = db.collection("requests").doc(key);

          try {
            await db.runTransaction(async (tx) => {
              const doc = await tx.get(docRef);
              const data = {
                artist: artistVal,
                title: titleVal,
                appleMusicUrl: appleMusicUrlVal,
                artworkUrl: artworkUrlVal,
                lastRequested: now,
                genre: genreVal,
                releaseYear: releaseYearVal,
                bpm: bpmVal,
              };
              if (doc.exists) {
                tx.update(docRef, {
                  ...data,
                  count: firebase.firestore.FieldValue.increment(1),
                });
              } else {
                tx.set(docRef, {
                  ...data,
                  timestamp: now,
                  fulfilled: false,
                  count: 1,
                });
              }
            });

            saveRequestData(now, key);

            // Increment and check request counter for social media modal
            let socialCount = parseInt(
              sessionStorage.getItem("socialCount") || "0",
              10
            );
            socialCount++;
            sessionStorage.setItem("socialCount", socialCount);

            if (socialCount >= 3) {
              socialModal.classList.remove("hidden"); 
              sessionStorage.setItem("socialCount", "0"); // Reset after showing
            }

            warning.classList.add("hidden");
            confirmation.classList.remove("hidden");
            setTimeout(() => confirmation.classList.add("hidden"), 5000);
            form.reset();
            card.classList.add("hidden");
            submitBtn.disabled = true;
          } catch (e) {
            console.error("Submission failed:", e);
            warning.textContent = "Request failed. Please try again.";
            warning.classList.remove("hidden");
            submitBtn.disabled = false;
          }
        });

        // hide confirmation and modals on load
        window.addEventListener("load", () => {
          confirmation.classList.add("hidden");
          socialModal.classList.add("hidden");
          warning.classList.add("hidden");
          blockedArtistModal.setAttribute("aria-hidden", "true"); 
        });
      })();
    </script>
  </body>
</html>
