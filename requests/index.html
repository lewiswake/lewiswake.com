<!-- song-request-form.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Song Request</title>
    <link rel="stylesheet" href="song-request-form.css" />
  </head>
  <body>
    <main class="wrapper">
      <h1 class="title">ğŸµ Request a Song</h1>
      <form
        id="requestForm"
        class="form"
        aria-describedby="confirmation"
        novalidate
      >
        <label for="searchInput" class="visually-hidden">ğŸ” Search song</label>
        <input
          type="search"
          id="searchInput"
          class="input"
          placeholder="Start typing a songâ€¦"
          autocomplete="off"
          required
          aria-autocomplete="list"
          aria-controls="suggestions"
          aria-live="polite"
        />

        <ul
          id="suggestions"
          class="suggestions"
          role="listbox"
          aria-label="Song suggestions"
        ></ul>

        <!-- Hidden fields populated on select -->
        <input type="hidden" id="artist" name="artist" />
        <input type="hidden" id="title" name="title" />
        <input type="hidden" id="appleMusicUrl" name="appleMusicUrl" />
        <input type="hidden" id="artworkUrl" name="artworkUrl" />
        <input type="hidden" id="genre" name="genre" />
        <input type="hidden" id="releaseYear" name="releaseYear" />
        <input type="hidden" id="bpm" name="bpm" />

        <div
          id="selectedSongCard"
          class="card hidden"
          role="region"
          aria-live="polite"
        >
          <h2 class="card-heading">Your request</h2>
          <div class="card-body">
            <img
              id="cardArtwork"
              src=""
              alt="Song artwork"
              class="card-thumb"
            />
            <div>
              <div id="cardTitle" class="card-title"></div>
              <div id="cardArtist" class="card-artist"></div>
            </div>
          </div>
        </div>

        <button type="submit" id="submitButton" class="button" disabled>
          Submit
        </button>
      </form>

      <div id="confirmation" class="confirmation hidden" role="status">
        âœ… Song request sent!
      </div>

      <hr class="divider" />
      <section class="tip-footer">
        <h2>ğŸ§ Follow the DJ</h2>
        <a
          href="https://www.instagram.com/lewiswakedj"
          class="button"
          target="_blank"
          rel="noopener noreferrer"
        >
          ğŸ“¸ Instagram
        </a>
        <a
          href="https://www.tiktok.com/@lewiswakedj"
          class="button"
          target="_blank"
          rel="noopener noreferrer"
        >
          ğŸ¶ TikTok
        </a>
      </section>

      <hr class="divider" />
      <section class="tip-footer">
        <h2>ğŸ» Buy the DJ a drink</h2>
        <a
          href="https://www.paypal.me/lewiswake"
          class="button"
          target="_blank"
          rel="noopener noreferrer"
        >
          ğŸ’³ PayPal
        </a>
      </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      (function () {
        // â€”â€”â€” Firebase Configuration â€”â€”â€”
        const firebaseConfig = {
          apiKey: "AIzaSyBLZp3f5WAWkAJDpBidh-C2mib2nhnLys4",
          authDomain: "song-request-a8a68.firebaseapp.com",
          projectId: "song-request-a8a68",
          storageBucket: "song-request-a8a68.appspot.com",
          messagingSenderId: "522633732679",
          appId: "1:522633732679:web:564894980a2e0484828762",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // â€”â€”â€” Spotify Credentials â€”â€”â€”
        const SPOTIFY_ID = "87b9b15a818244ef8604136016427eb8";
        const SPOTIFY_SECRET = "6787632ded984a939f3fbef54921a3b1";

        // â€”â€”â€” DOM Elements â€”â€”â€”
        const searchInput = document.getElementById("searchInput");
        const suggestions = document.getElementById("suggestions");
        const form = document.getElementById("requestForm");
        const submitBtn = document.getElementById("submitButton");
        const confirmation = document.getElementById("confirmation");
        const card = document.getElementById("selectedSongCard");
        const cardArtwork = document.getElementById("cardArtwork");
        const cardTitle = document.getElementById("cardTitle");
        const cardArtist = document.getElementById("cardArtist");

        let debounceTimer;

        function debounce(fn, delay = 300) {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(fn, delay);
        }
        function clearSuggestions() {
          suggestions.innerHTML = "";
          suggestions.setAttribute("aria-expanded", "false");
        }
        function showCard() {
          card.classList.remove("hidden");
          submitBtn.disabled = false;
        }

        searchInput.addEventListener("input", () => {
          debounce(async () => {
            const q = searchInput.value.trim();
            if (q.length < 2) return clearSuggestions();
            try {
              const res = await fetch(
                `https://itunes.apple.com/search?term=${encodeURIComponent(
                  q
                )}&entity=song&limit=5`
              );
              const { results } = await res.json();
              suggestions.innerHTML = "";
              suggestions.setAttribute("aria-expanded", "true");
              results.forEach((t) => {
                const li = document.createElement("li");
                li.className = "suggestion-item";
                li.setAttribute("role", "option");
                li.innerHTML = `
                  <img src="${t.artworkUrl60}" class="suggestion-thumb" />
                  <div class="suggestion-text">
                    <div class="track-title">${t.trackName}</div>
                    <div class="track-artist">${t.artistName}</div>
                  </div>
                `;
                li.addEventListener("click", () => selectTrack(t));
                suggestions.appendChild(li);
              });
            } catch (err) {
              console.error("Search failed:", err);
              clearSuggestions();
            }
          });
        });

        function selectTrack(track) {
          form.artist.value = track.artistName;
          form.title.value = track.trackName;
          form.appleMusicUrl.value = track.trackViewUrl;
          form.artworkUrl.value = track.artworkUrl100;

          cardArtwork.src = track.artworkUrl100;
          cardArtwork.alt = `${track.trackName} artwork`;
          cardTitle.textContent = track.trackName;
          cardArtist.textContent = track.artistName;
          clearSuggestions();

          // Genre & Year
          const genreVal = track.primaryGenreName;
          const yearVal = new Date(track.releaseDate).getFullYear();
          form.genre.value = genreVal;
          form.releaseYear.value = yearVal;

          // Fetch BPM directly
          fetchSpotifyBPM(track.trackName, track.artistName)
            .then((tempo) => {
              form.bpm.value = Math.round(tempo);
              showCard();
            })
            .catch((err) => {
              console.warn("BPM fetch failed:", err);
              form.bpm.value = 0;
              showCard();
            });
        }

        async function fetchSpotifyBPM(title, artist) {
          const creds = btoa(`${SPOTIFY_ID}:${SPOTIFY_SECRET}`);
          const tokenRes = await fetch(
            "https://accounts.spotify.com/api/token",
            {
              method: "POST",
              headers: {
                Authorization: `Basic ${creds}`,
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: "grant_type=client_credentials",
            }
          );
          if (!tokenRes.ok) throw new Error("Failed to fetch token");
          const { access_token } = await tokenRes.json();

          const q = encodeURIComponent(`track:${title} artist:${artist}`);
          const searchRes = await fetch(
            `https://api.spotify.com/v1/search?q=${q}&type=track&limit=1`,
            { headers: { Authorization: `Bearer ${access_token}` } }
          );
          const items = (await searchRes.json()).tracks.items;
          if (!items.length) throw new Error("No track match");

          const featRes = await fetch(
            `https://api.spotify.com/v1/audio-features/${items[0].id}`,
            { headers: { Authorization: `Bearer ${access_token}` } }
          );
          const { tempo } = await featRes.json();
          return tempo;
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          submitBtn.disabled = true;

          const artistVal = form.artist.value;
          const titleVal = form.title.value;
          const appleMusicUrlVal = form.appleMusicUrl.value;
          const artworkUrlVal = form.artworkUrl.value;
          const genreVal = form.genre.value;
          const releaseYearVal = parseInt(form.releaseYear.value, 10);
          const bpmVal = parseInt(form.bpm.value, 10);

          const key = `${artistVal.toLowerCase()}||${titleVal.toLowerCase()}`;
          const now = Date.now();
          const docRef = db.collection("requests").doc(key);

          await db.runTransaction(async (tx) => {
            const doc = await tx.get(docRef);
            const data = {
              artist: artistVal,
              title: titleVal,
              appleMusicUrl: appleMusicUrlVal,
              artworkUrl: artworkUrlVal,
              lastRequested: now,
              genre: genreVal,
              releaseYear: releaseYearVal,
              bpm: bpmVal,
            };
            if (doc.exists) {
              tx.update(docRef, {
                ...data,
                count: firebase.firestore.FieldValue.increment(1),
              });
            } else {
              tx.set(docRef, {
                ...data,
                timestamp: now,
                fulfilled: false,
                count: 1,
              });
            }
          });

          confirmation.classList.remove("hidden");
          setTimeout(() => confirmation.classList.add("hidden"), 5000);
          form.reset();
          card.classList.add("hidden");
        });

        window.addEventListener("load", () =>
          confirmation.classList.add("hidden")
        );
      })();
    </script>
  </body>
</html>
